<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Mode Hub ‚Äî Calm, Focused, Snack-worthy Breaks</title>
  <meta name="description" content="A calming, single-file study app with Book, Film, Article, and Essay modes, dark mode, autosave, and friendly snack-break timers." />
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50' font-size='50'>üéì</text></svg>">

  <!--
  SPDX-License-Identifier: LicenseRef-UseOnly
  Copyright (c) 2025 Your Name. All rights reserved.
  Licensed for access-only use from the Licensor‚Äôs source. Copying, redistribution,
  self-hosting, modification, or reverse engineering are prohibited. See LICENSE.
  -->

  <style>
    :root{
      --bg: #f7fbff;
      --card: #ffffff;
      --ink: #13233a;
      --muted: #667792;
      --brand: #77aaff;
      --brand-2: #7ee0c2;
      --accent: #ffd37e;
      --ring-bg: #e7f0ff;
      --shadow: 0 10px 30px rgba(19,35,58,0.10);
      --radius-lg: 18px;
      --radius-md: 14px;
      --wrap: min(100%, 1100px);
      --pad: clamp(16px, 2.2vw, 24px);
      --cta-h: 44px;
    }
    html[data-theme="dark"]{
      --bg:#0f1622; --card:#0f1b2e; --ink:#e8f1ff; --muted:#b7c4d6;
      --brand:#7bb2ff; --brand-2:#61d9bd; --ring-bg:#14233a;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #e9f3ff, transparent 60%),
        radial-gradient(1200px 600px at 110% 10%, #e8fff6, transparent 60%),
        var(--bg);
      transition: background 200ms ease, color 200ms ease;
    }
    a{color:#0b5cab; text-decoration:none}
    a:hover{text-decoration:underline}

    .nav{width:var(--wrap); margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:14px var(--pad)}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; font-size: clamp(18px,2.4vw,22px)}
    .brand .logo{font-size:1.4em}
    .nav-ctas{display:flex; gap:10px}
    .btn,.btn-ghost{height:var(--cta-h); padding:0 14px; border-radius:999px; border:0; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700}
    .btn{background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#073b4c; box-shadow:var(--shadow)}
    .btn-ghost{background:rgba(255,255,255,.85); color:#073b4c; box-shadow:var(--shadow)}
    html[data-theme="dark"] .btn-ghost{background:#162643; color:#d9ecff}

    .hero{
      width:var(--wrap); margin:12px auto 24px; padding:var(--pad);
      display:grid; gap:18px;
      background:linear-gradient(135deg, rgba(119,170,255,.15), rgba(126,224,194,.15));
      border-radius:var(--radius-lg); box-shadow:var(--shadow)
    }
    .hero h1{margin:6px 0 0 0; font-size:clamp(24px,4.6vw,42px); line-height:1.1}
    .hero p.sub{margin:0; color:var(--muted); font-size:clamp(14px,2.1vw,18px)}
    .hero-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
    .kudos{display:flex; gap:14px; flex-wrap:wrap; margin-top:10px; align-items:center; color:var(--muted); font-size:14px}
    .k-badge{background:#fff; border-radius:999px; padding:8px 12px; box-shadow:var(--shadow)}
    html[data-theme="dark"] .k-badge{background:#0f1b2e}

    .wrap{width:var(--wrap); margin:0 auto; padding:0 var(--pad)}
    .section{margin:34px 0}
    .section h2{font-size:clamp(20px,3.2vw,28px); margin:0 0 8px}
    .benefits{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card); border-radius:var(--radius-md); box-shadow:var(--shadow); padding:18px}
    .card h3{margin:0 0 6px 0; font-size:18px}
    .card p{margin:0; color:var(--muted); font-size:14px}

    .quotes{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .quote{background:var(--card); border-left:4px solid var(--brand); padding:16px; border-radius:12px; box-shadow:var(--shadow)}
    .quote .who{margin-top:8px; color:var(--muted); font-size:14px}

    .app{margin-top:36px}
    .mode-buttons{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:14px; margin:14px 0 18px}
    .mode-btn{display:flex; align-items:center; justify-content:center; gap:10px; border:0; border-radius:18px; padding:16px 18px; font-size:clamp(15px,1.8vw,18px); cursor:pointer; color:#073b4c; background:linear-gradient(180deg,#fff,#f4faff); box-shadow:var(--shadow); transition:transform .12s ease, box-shadow .12s ease}
    html[data-theme="dark"] .mode-btn{background:linear-gradient(180deg,#111c2f,#0c1627); color:#d9ecff}
    .mode-btn:hover{transform:translateY(-2px)}

    .app-card{display:none}
    .grid{display:grid; gap:14px}
    @media (min-width:720px){ .two{grid-template-columns:1fr 1fr} }
    label{display:block; margin:0 0 6px; font-size:14px; color:var(--muted)}
    input[type="text"], input[type="number"]{width:100%; border:1px solid #e6edf7; border-radius:12px; padding:12px 14px; font-size:16px; background:#fbfdff; outline:none; transition:box-shadow .12s ease, border-color .12s ease, background 200ms ease}
    html[data-theme="dark"] input{background:#0e1a2b; border-color:#1a2a45; color:var(--ink)}
    input:focus{border-color:#cfe2ff; box-shadow:0 0 0 4px #eaf3ff}
    html[data-theme="dark"] input:focus{box-shadow:0 0 0 4px rgba(123,178,255,.25)}
    .primary{height:var(--cta-h); padding:0 16px; border-radius:12px; border:0; font-weight:700; cursor:pointer; background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#073b4c; box-shadow:var(--shadow)}

    /* Book progress + cover */
    .chapter-progress{display:none}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#f2f8ff; color:#24507a; border-radius:999px; font-size:14px}
    html[data-theme="dark"] .pill{background:#0e1a2b; color:#b8d7ff}
    .chapter-flex{display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap}
    .book-cover{width:140px; height:210px; border-radius:10px; object-fit:cover; box-shadow:var(--shadow); background:#eef3fb}
    .chapter-list{display:flex; flex:1; flex-wrap:wrap; gap:10px}
    .chip{background:#eef6ff; color:#184b74; border:1px solid #dbeaff; border-radius:999px; padding:8px 12px; cursor:pointer; font-size:14px}
    .chip.completed{background:#184b74; color:#fff; border-color:#184b74}
    html[data-theme="dark"] .chip{background:#0f1b2e; color:#cfe3ff; border-color:#1d2c45}
    html[data-theme="dark"] .chip.completed{background:#2a5a99; border-color:#2a5a99}

    .break{display:none; text-align:center}
    .ring-wrap{width:min(320px,70vw); aspect-ratio:1/1; border-radius:50%; margin:10px auto 16px; display:grid; place-items:center; background:radial-gradient(circle at 50% 50%, var(--card) 42%, transparent 43%), conic-gradient(var(--brand) calc(var(--progress, 0) * 1%), #e8f0ff 0); box-shadow: inset 0 0 0 10px var(--ring-bg), 0 12px 36px rgba(19,35,58,0.10)}
    html[data-theme="dark"] .ring-wrap{background:radial-gradient(circle at 50% 50%, var(--card) 42%, transparent 43%), conic-gradient(var(--brand) calc(var(--progress, 0) * 1%), #15243d 0); box-shadow: inset 0 0 0 10px var(--ring-bg), 0 12px 36px rgba(0,0,0,0.4)}
    .ring-core{width:62%; aspect-ratio:1/1; border-radius:50%; background:var(--card); display:grid; place-items:center; box-shadow:var(--shadow)}
    .timer{font-size:clamp(24px,6vw,40px); font-weight:800; letter-spacing:.5px}
    .sub{color:var(--muted)}

    .toast{position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0b5cab; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease}
    .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-4px)}

    footer{width:var(--wrap); margin:34px auto; padding:0 var(--pad); text-align:center; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <nav class="nav" aria-label="Top">
    <div class="brand"><span class="logo" aria-hidden="true">üéì</span>Study Mode Hub</div>
    <div class="nav-ctas">
      <button id="themeToggle" class="btn-ghost" aria-label="Toggle dark mode">üåô Dark</button>
      <a class="btn" href="#app" aria-label="Open the study app">Start Studying</a>
    </div>
  </nav>

  <header class="hero" role="banner">
    <h1>Make studying feel human‚Äîcalm focus, tiny wins, snack-worthy breaks.</h1>
    <p class="sub">Book, Film, Article, and Essay modes with a gentle timer. Autosaves your progress. One click to dark mode.</p>
    <div class="hero-actions">
      <a class="btn" href="#app">Open App</a>
      <a class="btn-ghost" href="#how">How it works</a>
    </div>
    <div class="kudos" aria-label="Social proof">
      <span class="k-badge">‚≠ê Quick setup (1 file)</span>
      <span class="k-badge">üì± Mobile-friendly</span>
      <span class="k-badge">üåì Dark mode</span>
      <span class="k-badge">üíæ Autosave</span>
    </div>
  </header>

  <main class="wrap" id="content">
    <section class="section" id="how" aria-labelledby="how-h">
      <h2 id="how-h">Why it works</h2>
      <div class="benefits">
        <article class="card"><h3>Clear, single goal</h3><p>Start a mode and focus. Primary actions are obvious and above the fold.</p></article>
        <article class="card"><h3>Benefit-first copy</h3><p>Headlines explain value, not features. You always know what to do next.</p></article>
        <article class="card"><h3>Calm design</h3><p>Roomy spacing, readable type, soft gradients, and accessible contrast.</p></article>
        <article class="card"><h3>Conversion cues</h3><p>Prominent CTAs, minimal friction, and delightful feedback keep momentum.</p></article>
      </div>
    </section>

    <section class="section" aria-labelledby="proof-h">
      <h2 id="proof-h">What learners say</h2>
      <div class="quotes" role="list">
        <blockquote class="quote" role="listitem">‚ÄúThe chapter chips and five-minute breaks tricked my brain into enjoying study sessions.‚Äù<div class="who">‚Äî J., high school</div></blockquote>
        <blockquote class="quote" role="listitem">‚ÄúIt feels like a cozy app, not a chore. Dark mode at night is perfect.‚Äù<div class="who">‚Äî A., college</div></blockquote>
        <blockquote class="quote" role="listitem">‚ÄúSimple. Fast. Exactly what I needed before exams.‚Äù <div class="who">‚Äî R., grad student</div></blockquote>
      </div>
    </section>

    <section class="section app" id="app" aria-labelledby="app-h">
      <h2 id="app-h">Open the app</h2>

      <div class="mode-buttons" aria-label="Study modes">
        <button class="mode-btn" data-mode="book" aria-controls="book"><span aria-hidden="true">üìñ</span>Book</button>
        <button class="mode-btn" data-mode="film" aria-controls="film"><span aria-hidden="true">üé¨</span>Film</button>
        <button class="mode-btn" data-mode="article" aria-controls="article"><span aria-hidden="true">üì∞</span>Article</button>
        <button class="mode-btn" data-mode="essay" aria-controls="essay"><span aria-hidden="true">üìù</span>Essay</button>
      </div>

      <!-- Book -->
      <article id="book" class="card app-card" tabindex="-1" aria-labelledby="book-h">
        <h3 id="book-h">Book Mode</h3>
        <p class="sub">Enter details. Tap a chapter to complete. Enjoy a gentle 5-minute break.</p>
        <div class="grid two">
          <div>
            <label for="bookTitle">Title</label>
            <input id="bookTitle" type="text" placeholder="The Lightning Thief" inputmode="text">
          </div>
          <div>
            <label for="bookAuthor">Author</label>
            <input id="bookAuthor" type="text" placeholder="Rick Riordan">
          </div>
          <div>
            <label for="bookISBN">ISBN (10 or 13)</label>
            <input id="bookISBN" type="text" placeholder="9780786838653" inputmode="numeric" aria-describedby="isbnHelp">
            <small id="isbnHelp" class="sub">We‚Äôll fetch a cover from Open Library (fallback Google Books).</small>
          </div>
          <div>
            <label for="bookChapters">Number of Chapters</label>
            <input id="bookChapters" type="number" min="1" placeholder="22">
          </div>
        </div>

        <!-- Live cover preview -->
        <div style="display:flex; align-items:center; gap:14px; margin-top:10px">
          <img id="bookCoverPreview" class="book-cover" alt="Book cover preview" src="" style="display:none" />
          <div class="sub" id="coverStatus" aria-live="polite"></div>
        </div>

        <div style="height:8px"></div>
        <button class="primary" id="startBook">Start Book Session</button>
      </article>

      <!-- Progress -->
      <article id="chapterProgress" class="card chapter-progress" aria-live="polite">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px">
          <div id="bookInfo" class="pill">üìö Your Book</div>
          <div class="pill" id="chapStats">0% done</div>
        </div>
        <div class="chapter-flex">
          <img id="bookCoverSmall" class="book-cover" alt="Book cover" src="" style="display:none"/>
          <div id="chapterButtons" class="chapter-list" role="list"></div>
        </div>
      </article>

      <!-- Film -->
      <article id="film" class="card app-card" tabindex="-1" aria-labelledby="film-h">
        <h3 id="film-h">Film Mode</h3>
        <p class="sub">Log a watch, then take a calm 5-minute pause to reset your brain.</p>
        <div class="grid two">
          <div><label for="filmTitle">Film Title</label><input id="filmTitle" type="text" placeholder="Spirited Away"></div>
          <div><label for="filmDirector">Director</label><input id="filmDirector" type="text" placeholder="Hayao Miyazaki"></div>
          <div><label for="filmRuntime">Runtime (minutes)</label><input id="filmRuntime" type="number" min="1" placeholder="125"></div>
        </div>
        <div style="height:8px"></div>
        <button class="primary" id="startFilm">Start Film Session</button>
      </article>

      <!-- Article -->
      <article id="article" class="card app-card" tabindex="-1" aria-labelledby="article-h">
        <h3 id="article-h">Article Mode</h3>
        <p class="sub">Read by pages or sections and celebrate with a short snack break.</p>
        <div class="grid two">
          <div><label for="articleTitle">Article Title</label><input id="articleTitle" type="text" placeholder="Neural Attention Mechanisms"></div>
          <div><label for="articleAuthor">Author</label><input id="articleAuthor" type="text" placeholder="M. Vaswani et al."></div>
          <div><label for="articlePages">Number of Pages</label><input id="articlePages" type="number" min="1" placeholder="12"></div>
        </div>
        <div style="height:8px"></div>
        <button class="primary" id="startArticle">Start Article Session</button>
      </article>

      <!-- Essay -->
      <article id="essay" class="card app-card" tabindex="-1" aria-labelledby="essay-h">
        <h3 id="essay-h">Essay Mode</h3>
        <p class="sub">Write in calm bursts. When you hit a milestone, take five.</p>
        <div class="grid two">
          <div><label for="essayTitle">Essay Title</label><input id="essayTitle" type="text" placeholder="How Innovation Scales"></div>
          <div><label for="essayTopic">Topic</label><input id="essayTopic" type="text" placeholder="Organizational agility"></div>
          <div><label for="essayWords">Target Word Count</label><input id="essayWords" type="number" min="100" placeholder="1200"></div>
        </div>
        <div style="height:8px"></div>
        <button class="primary" id="startEssay">Start Essay Session</button>
      </article>

      <!-- Break -->
      <article id="breakTimer" class="card break" aria-live="polite" tabindex="-1" aria-labelledby="break-h">
        <h3 id="break-h">üçé Break Time</h3>
        <p class="sub">Grab water. Stretch. Snack. Your calm countdown is below.</p>
        <div class="ring-wrap" id="ring" style="--progress:0;">
          <div class="ring-core"><div id="timerText" class="timer" aria-live="assertive">5:00</div></div>
        </div>
        <p class="sub">Pro tip: look far away for 20 seconds to rest your eyes.</p>
        <div style="display:flex;justify-content:center;gap:10px;margin-top:8px">
          <button class="primary" id="endEarly">I‚Äôm ready now</button>
        </div>
      </article>
    </section>
  </main>

  <footer>
    ¬© 2025 Your Name. All rights reserved. Use-only license. No copying or redistribution. ‚Ä¢ <a href="#content">Back to top</a>
  </footer>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script defer>
    /* ---------- Keys ---------- */
    const KEY_THEME = 'smh_theme';
    const KEY_BOOK  = 'smh_book';
    const KEY_LASTS = 'smh_last_inputs';

    /* ---------- Theme ---------- */
    const themeBtn = document.getElementById('themeToggle');
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
      localStorage.setItem(KEY_THEME, theme);
    }
    function initTheme(){
      const saved = localStorage.getItem(KEY_THEME);
      if(saved){ applyTheme(saved); }
      else { const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark ? 'dark' : 'light'); }
    }
    themeBtn.addEventListener('click', () => { applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); });

    /* ---------- Utilities ---------- */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const val    = id => (document.getElementById(id)?.value || '').trim();
    const setVal = (id,v) => { const el=document.getElementById(id); if(el) el.value = v ?? ''; };
    const clampInt = (v,min,max) => { const n=parseInt(v,10); if(Number.isNaN(n)) return null; return Math.max(min, Math.min(max,n)); };
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    function smoothTo(el){ el?.scrollIntoView({ behavior:'smooth', block:'start' }); }

    /* ---------- Toast ---------- */
    const toast = document.getElementById('toast'); let toastTO;
    function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); clearTimeout(toastTO); toastTO=setTimeout(()=>toast.classList.remove('show'), 2200); }

    /* ---------- Cards/show-hide ---------- */
    const appCards = $$('.app-card');
    function hideAllCards(){ appCards.forEach(c => c.style.display='none'); $('#chapterProgress').style.display='none'; $('#breakTimer').style.display='none'; }
    function showCard(id){ hideAllCards(); const el=document.getElementById(id); el.style.display='block'; el.focus({preventScroll:true}); smoothTo(el); }

    /* ---------- Persistence of non-book inputs ---------- */
    function saveLastInputs(){
      const obj = {
        filmTitle: val('filmTitle'), filmDirector: val('filmDirector'), filmRuntime: val('filmRuntime'),
        articleTitle: val('articleTitle'), articleAuthor: val('articleAuthor'), articlePages: val('articlePages'),
        essayTitle: val('essayTitle'), essayTopic: val('essayTopic'), essayWords: val('essayWords'),
      };
      localStorage.setItem(KEY_LASTS, JSON.stringify(obj));
    }
    function loadLastInputs(){
      try{
        const o = JSON.parse(localStorage.getItem(KEY_LASTS)||'{}');
        setVal('filmTitle', o.filmTitle); setVal('filmDirector', o.filmDirector); setVal('filmRuntime', o.filmRuntime);
        setVal('articleTitle', o.articleTitle); setVal('articleAuthor', o.articleAuthor); setVal('articlePages', o.articlePages);
        setVal('essayTitle', o.essayTitle); setVal('essayTopic', o.essayTopic); setVal('essayWords', o.essayWords);
      }catch{}
    }

    /* ---------- Book mode (with cover + persistence) ---------- */
    function loadBook(){ try{ return JSON.parse(localStorage.getItem(KEY_BOOK) || 'null'); } catch{ return null; } }
    function saveBook(b){ localStorage.setItem(KEY_BOOK, JSON.stringify(b)); }
    function doneList(){ const b=loadBook(); return b?.done ?? []; }
    function updateChapterStats(){
      const chips = $$('.chip');
      const done = chips.filter(c => c.classList.contains('completed')).length;
      const pct = chips.length ? Math.round((done/chips.length)*100) : 0;
      $('#chapStats').textContent = `${pct}% done`;
    }
    function toggleChapter(i){
      const b = loadBook(); if(!b) return;
      const idx = b.done.indexOf(i);
      (idx>=0) ? b.done.splice(idx,1) : b.done.push(i);
      saveBook(b); updateChapterStats();
    }
    function renderBook(b){
      $('#bookInfo').textContent = `üìö ${b.title} ‚Äî ${b.author} ‚Ä¢ ISBN ${b.isbn}`;
      const coverSmall = $('#bookCoverSmall');
      if(b.coverUrl){ coverSmall.src = b.coverUrl; coverSmall.style.display='block'; coverSmall.alt = `Cover of ${b.title}`; }
      else { coverSmall.removeAttribute('src'); coverSmall.style.display='none'; }
      const list = $('#chapterButtons'); list.innerHTML='';
      for(let i=1;i<=b.chapters;i++){
        const btn = document.createElement('button');
        btn.className = 'chip' + (b.done.includes(i) ? ' completed' : '');
        btn.setAttribute('role','listitem');
        btn.textContent = `Chapter ${i}`;
        btn.addEventListener('click', () => {
          btn.classList.toggle('completed');
          toggleChapter(i);
          updateChapterStats();
          startBreak();
        });
        list.appendChild(btn);
      }
      updateChapterStats();
    }

    // --- ISBN helpers ---
    function cleanISBN(raw){
      const s = (raw||'').replace(/[^0-9Xx]/g,'').toUpperCase();
      if(s.length===10 || s.length===13) return s;
      return null;
    }
    function openLibraryCoverURL(isbn){ return `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`; } // Large
    async function imageExists(url){
      return new Promise(resolve=>{
        const img = new Image();
        img.onload = ()=>resolve(true);
        img.onerror = ()=>resolve(false);
        img.src = url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now();
      });
    }
    async function fetchGoogleBooksCover(isbn){
      try{
        const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${encodeURIComponent(isbn)}`);
        const data = await res.json();
        const item = data?.items?.[0];
        const link = item?.volumeInfo?.imageLinks?.thumbnail || item?.volumeInfo?.imageLinks?.smallThumbnail;
        if(link){ return link.replace('http://','https://'); }
      }catch(e){}
      return null;
    }
    async function resolveCoverURL(isbn){
      // Try Open Library first
      const ol = openLibraryCoverURL(isbn);
      if(await imageExists(ol)) return ol;
      // Fallback: Google Books thumbnail
      const gb = await fetchGoogleBooksCover(isbn);
      if(gb) return gb;
      return null;
    }

    async function updateCoverPreview(force=false){
      const preview = $('#bookCoverPreview');
      const status  = $('#coverStatus');
      const isbn = cleanISBN(val('bookISBN'));
      if(!isbn){
        preview.style.display='none';
        preview.removeAttribute('src');
        status.textContent = 'Enter a valid 10 or 13 digit ISBN to fetch a cover.';
        return;
      }
      status.textContent = 'Looking up cover‚Ä¶';
      const url = await resolveCoverURL(isbn);
      if(url){
        preview.src = url; preview.style.display='block';
        preview.alt = `Book cover for ISBN ${isbn}`;
        status.textContent = 'Cover found ‚úî';
        if(force){
          const b = loadBook() || { title:'', author:'', isbn:isbn, chapters:1, done:[] };
          b.coverUrl = url; saveBook(b);
        }
      }else{
        preview.style.display='none';
        preview.removeAttribute('src');
        status.textContent = 'No cover found (Open Library / Google Books).';
      }
    }

    /* ---------- Timer ---------- */
    let timerInterval; const totalSeconds = 5*60; let remaining = totalSeconds;
    function startBreak(){
      clearInterval(timerInterval);
      remaining = totalSeconds;
      hideAllCards();
      $('#breakTimer').style.display = 'block';
      $('#breakTimer').focus({preventScroll:true});
      smoothTo($('#breakTimer'));
      tick();
      timerInterval = setInterval(tick, 1000);
    }
    function endBreakEarly(){
      clearInterval(timerInterval);
      $('#breakTimer').style.display = 'none';
      showToast('Break wrapped. Nice focus!');
      smoothTo($('#app'));
    }
    function tick(){
      const m = Math.floor(remaining/60), s = remaining%60;
      $('#timerText').textContent = `${m}:${String(s).padStart(2,'0')}`;
      const progress = Math.round(((totalSeconds-remaining)/totalSeconds)*100);
      $('#ring').style.setProperty('--progress', progress);
      if(remaining <= 0){
        clearInterval(timerInterval);
        $('#breakTimer').style.display='none';
        showToast('Break over ‚Äî you got this üí™');
        smoothTo($('#app'));
        return;
      }
      remaining -= 1;
    }

    /* ---------- Events ---------- */
    // Mode buttons
    $$('.mode-btn').forEach(b => {
      b.addEventListener('click', () => showCard(b.dataset.mode));
      b.addEventListener('keyup', e => { if(e.key==='Enter' || e.key===' ') showCard(b.dataset.mode); });
    });

    // Book: start
    $('#startBook').addEventListener('click', async () => {
      const title = val('bookTitle') || 'Untitled Book';
      const author = val('bookAuthor') || 'Unknown';
      const isbnRaw = val('bookISBN');
      const isbn = cleanISBN(isbnRaw) || '‚Äî';
      const chapters = clampInt(val('bookChapters'), 1, 999) || 1;

      let coverUrl = null;
      if(isbn && isbn !== '‚Äî'){
        $('#coverStatus').textContent = 'Finalizing cover‚Ä¶';
        coverUrl = await resolveCoverURL(isbn);
      }

      const data = { title, author, isbn, chapters, done: doneList().filter(i=>i<=chapters), coverUrl };
      saveBook(data); renderBook(data);
      hideAllCards(); $('#chapterProgress').style.display='block'; smoothTo($('#chapterProgress'));
      showToast('Book session started');
    });

    // Film / Article / Essay
    $('#startFilm').addEventListener('click', () => {
      const runtime = clampInt(val('filmRuntime'), 1, 10000);
      if(!runtime){ showToast('Enter a runtime in minutes'); return; }
      saveLastInputs(); showToast('Film session noted ‚Äî enjoy!'); startBreak();
    });
    $('#startArticle').addEventListener('click', () => {
      const pages = clampInt(val('articlePages'), 1, 5000);
      if(!pages){ showToast('Enter number of pages'); return; }
      saveLastInputs(); showToast('Article session noted'); startBreak();
    });
    $('#startEssay').addEventListener('click', () => {
      const words = clampInt(val('essayWords'), 100, 20000);
      if(!words){ showToast('Enter a target word count'); return; }
      saveLastInputs(); showToast('Writing session started'); startBreak();
    });

    $('#endEarly').addEventListener('click', endBreakEarly);

    // Auto-save book fields & live cover preview on ISBN input
    function autoSaveBookFields(){
      ['bookTitle','bookAuthor','bookISBN','bookChapters'].forEach(id=>{
        document.getElementById(id)?.addEventListener('input', async ()=>{
          const b = loadBook() || { title:'', author:'', isbn:'', chapters:1, done:[] };
          b.title = val('bookTitle') || b.title;
          b.author= val('bookAuthor') || b.author;
          const raw = val('bookISBN'); const cleaned = cleanISBN(raw); b.isbn = cleaned || raw || b.isbn;
          b.chapters = clampInt(val('bookChapters'),1,999) || b.chapters;
          b.done = (b.done||[]).filter(i=>i<=b.chapters);
          saveBook(b);

          if(id==='bookISBN'){ await updateCoverPreview(true); } // live fetch & persist cover
        });
      });
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      applyTheme('light'); // ensure button text sync on first paint
      initTheme();
      loadLastInputs();
      autoSaveBookFields();

      const savedBook = loadBook();
      if(savedBook){
        setVal('bookTitle', savedBook.title);
        setVal('bookAuthor', savedBook.author);
        setVal('bookISBN', savedBook.isbn);
        setVal('bookChapters', savedBook.chapters);
        // show preview cover if present, else try to resolve from saved ISBN
        if(savedBook.coverUrl){
          const p = $('#bookCoverPreview');
          p.src = savedBook.coverUrl; p.style.display='block'; p.alt = `Cover of ${savedBook.title}`;
          $('#coverStatus').textContent = 'Cover loaded ‚úî';
        } else if(savedBook.isbn && cleanISBN(savedBook.isbn)){
          $('#coverStatus').textContent = 'Looking up cover‚Ä¶';
          const url = await resolveCoverURL(cleanISBN(savedBook.isbn));
          if(url){
            const b = loadBook() || savedBook; b.coverUrl = url; saveBook(b);
            const p = $('#bookCoverPreview');
            p.src = url; p.style.display='block'; p.alt = `Cover of ${savedBook.title}`;
            $('#coverStatus').textContent = 'Cover found ‚úî';
          } else {
            $('#coverStatus').textContent = 'No cover found.';
          }
        }
        renderBook(loadBook());
        $('#chapterProgress').style.display='block';
      } else {
        // default helpful prompt for first-time users
        $('#coverStatus').textContent = 'Enter a valid ISBN to fetch the cover.';
      }
    });
  </script>
</body>
</html>
